---
title: database
---
import { LinkButton, Steps } from '@astrojs/starlight/components';

The `database` package provides PostgreSQL connection management with built-in migration support using sqlx.

Core Components:

- `Database`: Database connection with migration orchestration capabilities.
- `Migration`: Represents a single database migration with Up and Down SQL statements.
- `New(connection string) (*Database, error)`: Creates a new PostgreSQL database connection.
- `ParseMigrations(fsys fs.FS) ([]Migration, error)`: Parses SQL migration files from a filesystem.

[Full package docs at pkg.go.dev](https://pkg.go.dev/github.com/platforma-dev/platforma/database)

## Step-by-step guide

<Steps>

 1. Create a database connection

    ```go
    db, err := database.New("postgres://user:password@localhost:5432/mydb?sslmode=disable")
    if err != nil {
        log.ErrorContext(ctx, "failed to connect", "error", err)
        os.Exit(1)
    }
    ```

    This establishes a PostgreSQL connection using the provided connection string.

2. Define your repository with migrations

    ```go
    type UserRepository struct {
        db *sqlx.DB
    }

    //go:embed *.sql
    var migrations embed.FS

    func (r *UserRepository) Migrations() fs.FS {
        return migrations
    }
    ```

    The `Migrations()` method returns a filesystem containing SQL migration files.

3. Create SQL migration files

    ```sql
    -- 001_create_users_table.sql
    -- +migrate Up
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL,
        email TEXT UNIQUE NOT NULL
    );

    -- +migrate Down
    DROP TABLE users;
    ```

    Migration files use `-- +migrate Up` and `-- +migrate Down` markers to define schema changes.

4. Register your repository

    ```go
    userRepo := NewUserRepository(db.Connection())
    db.RegisterRepository("users", userRepo)
    ```

    Repositories that implement the `Migrations()` method returning `fs.FS` will automatically be registered for migration.

5. Run migrations

    ```go
    err = db.Migrate(ctx)
    if err != nil {
        log.ErrorContext(ctx, "failed to run migrations", "error", err)
        os.Exit(1)
    }
    ```

    This applies all pending migrations and tracks them in the `platforma_migrations` table.

6. Use the database connection

    ```go
    var users []User
    err := db.Connection().SelectContext(ctx, &users, "SELECT id, name, email FROM users")
    ```

    Access the underlying `sqlx.DB` connection through the `Connection()` method.

</Steps>

## Using with Application

The `Database` type does not implement the `Runner` interface. Instead, it's registered with the application using the dedicated database registration methods:

```go
app := application.New()

// Register database connection
app.RegisterDatabase("main", db)

// Register repositories with the database
app.RegisterRepository("main", "users", userRepo)

// Register services
app.RegisterService("api", httpServer)

// Run the application (starts services)
app.Run(ctx)
```

Migrations are NOT run automatically when starting services. You must run migrations separately using the CLI:

```bash
# Run migrations first
myapp migrate

# Then start services
myapp run
```

If migrations fail, the application will exit with an error.

## Migration file format

Migration files use special markers to separate up and down SQL:

```sql
-- +migrate Up
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

-- +migrate Down
DROP TABLE users;
```

| Marker | Required | Description |
|--------|----------|-------------|
| `-- +migrate Up` | Yes | Marks the start of the up migration SQL |
| `-- +migrate Down` | No | Marks the start of the down migration SQL |

The migration ID is derived from the filename without the `.sql` extension. For example, `001_create_users.sql` becomes ID `001_create_users`.

## Migration tracking

Migrations are tracked in the `platforma_migrations` table with three columns:

| Column | Description |
|--------|-------------|
| `repository` | Name used in `RegisterRepository` |
| `id` | Migration ID derived from the SQL filename |
| `timestamp` | When the migration was applied |

If a migration fails, previously applied migrations in the same batch are reverted using their `Down` SQL.

## Complete example

import { Code } from '@astrojs/starlight/components';
import importedCode from '../../../../../demo-app/cmd/database/main.go?raw';
import importedMigration from '../../../../../demo-app/cmd/database/001_create_users_table.sql?raw';

<Code code={importedMigration} lang="sql" title="001_create_users_table.sql" />

<Code code={importedCode} lang="go" title="main.go" />
