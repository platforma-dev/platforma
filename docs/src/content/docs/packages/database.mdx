---
title: database
---
import { LinkButton, Steps } from '@astrojs/starlight/components';

The `database` package provides PostgreSQL database connection and automatic migration functionality.

Core Components:

- `Database`: Manages database connection, repository registration, and migration execution
- `Migration`: Represents a database migration with `ID`, `Up`, and `Down` SQL statements
- `migrator` interface: Repositories implementing `Migrations() fs.FS` are automatically migrated

[Full package docs at pkg.go.dev](https://pkg.go.dev/github.com/platforma-dev/platforma/database)

## Step-by-step guide

<Steps>

1. Create a new database connection

    ```go
    db, err := database.New("postgres://user:password@localhost:5432/mydb?sslmode=disable")
    if err != nil {
        log.ErrorContext(ctx, "failed to connect", "error", err)
        os.Exit(1)
    }
    ```

    The connection string follows standard PostgreSQL format.

2. Create a SQL migration file

    ```sql
    // 001_create_users_table.sql
    -- +migrate Up
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        name TEXT NOT NULL
    );

    -- +migrate Down
    DROP TABLE users;
    ```

    Each migration file contains `-- +migrate Up` (required) and `-- +migrate Down` (optional) sections. The migration ID is derived from the filename.

3. Define a repository that embeds migrations

    ```go
    import (
        "embed"
        "io/fs"

        "github.com/jmoiron/sqlx"
    )

    //go:embed *.sql
    var migrations embed.FS

    type UserRepository struct {
        db *sqlx.DB
    }

    func NewUserRepository(db *sqlx.DB) *UserRepository {
        return &UserRepository{db: db}
    }

    func (r *UserRepository) Migrations() fs.FS {
        return migrations
    }
    ```

    The `Migrations()` method returns an `fs.FS` containing SQL files. Files are sorted lexicographically, so use numeric prefixes like `001_`, `002_` for ordering.

4. Get the underlying connection and create your repository

    ```go
    userRepo := NewUserRepository(db.Connection())
    ```

    `Connection()` returns the underlying `*sqlx.DB` for your repository operations.

5. Register the repository with the database

    ```go
    db.RegisterRepository("users", userRepo)
    ```

    Registration enables automatic migration when `Migrate()` is called.

6. Run migrations

    ```go
    err = db.Migrate(ctx)
    if err != nil {
        log.ErrorContext(ctx, "migration failed", "error", err)
        os.Exit(1)
    }
    ```

    Migrations are tracked in the `platforma_migrations` table. Only pending migrations are applied.

7. Use your repository

    ```go
    user, err := userRepo.Create(ctx, "John Doe")
    ```

    After migrations complete, your tables are ready for use.

</Steps>

## Using with Application

When using the `application` package, databases are migrated automatically during startup:

```go
app := application.New()

db, _ := database.New("postgres://user:pass@localhost:5432/mydb?sslmode=disable")
app.RegisterDatabase("main", db)

userRepo := NewUserRepository(db.Connection())
app.RegisterRepository("main", "users", userRepo)

app.RegisterService("api", httpServer)

app.Run(ctx)
```

The application runs migrations for all registered databases before starting services.

## Migration file format

Migration files use special markers to separate up and down SQL:

```sql
-- +migrate Up
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

-- +migrate Down
DROP TABLE users;
```

| Marker | Required | Description |
|--------|----------|-------------|
| `-- +migrate Up` | Yes | Marks the start of the up migration SQL |
| `-- +migrate Down` | No | Marks the start of the down migration SQL |

The migration ID is derived from the filename without the `.sql` extension. For example, `001_create_users.sql` becomes ID `001_create_users`.

## Migration tracking

Migrations are tracked in the `platforma_migrations` table with three columns:

| Column | Description |
|--------|-------------|
| `repository` | Name used in `RegisterRepository` |
| `id` | Migration ID derived from the SQL filename |
| `timestamp` | When the migration was applied |

If a migration fails, previously applied migrations in the same batch are reverted using their `Down` SQL.

## Complete example

import { Code } from '@astrojs/starlight/components';
import importedCode from '../../../../../demo-app/cmd/database/main.go?raw';
import importedMigration from '../../../../../demo-app/cmd/database/001_create_users_table.sql?raw';

<Code code={importedMigration} lang="sql" title="001_create_users_table.sql" />

<Code code={importedCode} lang="go" title="main.go" />
